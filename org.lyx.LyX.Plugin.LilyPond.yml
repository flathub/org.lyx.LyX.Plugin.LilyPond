id: org.lyx.LyX.Plugin.LilyPond
runtime: org.lyx.LyX
runtime-version: stable
sdk: org.kde.Sdk//5.15-23.08
build-extension: true
appstream-compose: false
sdk-extensions:
  - org.freedesktop.Sdk.Extension.texlive
build-options:
  prefix: /app/plugins/LilyPond
  append-path: /app/plugins/LilyPond/bin
  append-ld-library-path: /app/plugins/LilyPond/lib
  append-pkg-config-path: /app/plugins/LilyPond/lib/pkgconfig
cleanup:
  - /app/plugins/LilyPond/share/man
  - /app/plugins/LilyPond/include
modules:
  - name: gc-guile
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/ivmai/bdwgc.git
        tag: v8.2.8
        commit: ee59af3722e56de8404de6cd0c21c2493cc4d855
  - name: guile
    buildsystem: autotools
    config-opts:
      - --disable-docs
      #- --with-includes=/app/Extensions/include
      #- --with-libraries=/app/Extensions/lib
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/guile/guile-3.0.10.tar.xz
        sha256: bd7168517fd526333446d4f7ab816527925634094fbd37322e17e2b8d8e76388
  - name: fontforge
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DENABLE_DOCS=false
      - -DENABLE_LIBSPIRO=false
      - -DREAL_TYPE=double
      - -DCMAKE_INCLUDE_PATH=/app/plugins/LilyPond/include
    sources:
      - type: archive
        url: https://github.com/fontforge/fontforge/archive/refs/tags/20230101.tar.gz
        sha256: ab0c4be41be15ce46a1be1482430d8e15201846269de89df67db32c7de4343f1
      # From https://src.fedoraproject.org/rpms/fontforge/blob/rawhide/f/0001-Fix-errors-in-French-and-Italian-translations.patch
      - type: patch
        path: fontforge-translation-errors.patch
  - name: t1utils
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/kohler/t1utils/archive/v1.41.tar.gz
        sha256: 0129fbfabb212143f52ff1e5de8ccbef5e5295d46772bad3ed149115bab5a094
  - name: texgyre
    sources:
      - type: archive
        url: https://www.gust.org.pl/projects/e-foundry/tex-gyre/whole/tg2_501otf.zip
        sha256: d7f8be5317bec4e644cf16c5abf876abeeb83c43dbec0ccb4eee4516b73b1bbe
    buildsystem: simple
    build-commands:
      - mkdir /app/plugins/LilyPond/share/fonts
      - install * /app/plugins/LilyPond/share/fonts
      
  - name: lilypond
    buildsystem: autotools
    config-opts: 
      - --disable-documentation
      - --enable-cairo-backend
    build-options:
      arch:
        aarch64:
          prepend-path: /usr/lib/sdk/texlive/bin/aarch64-linux:/usr/lib/sdk/texlive/bin
        x86_64:
          prepend-path: /usr/lib/sdk/texlive/bin/x86_64-linux:/usr/lib/sdk/texlive/bin
    post-install: 
      - install -Dm644 --target-directory=${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
      - appstream-compose --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} --origin=flatpak
        ${FLATPAK_ID}
    sources:
      - type: archive
        url: https://lilypond.org/download/sources/v2.24/lilypond-2.24.4.tar.gz
        sha256: e96fa03571c79f20e1979653afabdbe4ee42765a3d9fd14953f0cd9eea51781c
      - type: file
        path: org.lyx.LyX.Plugin.LilyPond.metainfo.xml
